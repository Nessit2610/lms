<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Hộp thoại Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3/build/jwt-decode.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: #ffffff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .user-search-container {
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }

        .user-search-container input {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .user-search-container button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .user-search-container button:hover {
            background-color: #0056b3;
        }

        .chat-list-container {
            flex-grow: 1;
            overflow-y: auto;
        }

        .chat-list-container h3 {
            margin-top: 0;
            font-size: 16px;
            color: #333;
        }

        .chat-list-item {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease;
        }

        .chat-list-item:hover {
            background-color: #f0f8ff;
        }

        .chat-list-item.active {
            background-color: #e6f3ff;
            font-weight: bold;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-transform: uppercase;
        }

        .chat-info .chat-name {
            font-size: 14px;
            color: #333;
            margin-bottom: 3px;
        }

        .chat-info .last-message {
            font-size: 12px;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }


        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #e5ddd5;
        }

        .chat-header {
            padding: 15px 20px;
            background-color: #007bff;
            color: white;
            font-size: 18px;
            border-bottom: 1px solid #0056b3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-title {
            flex-grow: 1;
        }

        .chat-header-actions {
            display: flex;
            align-items: center;
        }

        .add-member-ui button,
        .chat-header button#showAddMemberInputButton,
        .chat-header button#viewChatMembersButton {
            background-color: transparent;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px 8px;
            margin-left: 10px;
        }

        .add-member-ui button:hover,
        .chat-header button#showAddMemberInputButton:hover,
        .chat-header button#viewChatMembersButton:hover {
            opacity: 0.8;
        }

        #addMemberInputContainer {
            display: flex;
            align-items: center;
        }

        #addMemberInputContainer input {
            padding: 5px 8px;
            border-radius: 3px;
            border: 1px solid #ccc;
            margin-right: 5px;
            font-size: 0.9em;
        }

        #addMemberInputContainer button {
            padding: 5px 10px;
            background-color: #fff;
            color: #007bff;
            border: 1px solid #007bff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }

        #addMemberInputContainer button:hover {
            background-color: #f0f0f0;
        }

        .messages-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 70%;
            word-wrap: break-word;
            position: relative;
        }

        .message.sent {
            background-color: #dcf8c6;
            align-self: flex-end;
            border-bottom-right-radius: 3px;
        }

        .message.received {
            background-color: #ffffff;
            align-self: flex-start;
            border-bottom-left-radius: 3px;
        }

        .message .sender-name {
            font-size: 0.75em;
            color: #555;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .message .message-content {
            font-size: 0.9em;
            padding-right: 30px;
        }

        .message-time-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            font-size: 0.7em;
            color: #aaa;
            margin-top: 3px;
            position: absolute;
            bottom: 5px;
            right: 10px;
        }

        .message-time {
            margin-right: 5px;
        }

        .status-indicator {
            font-weight: bold;
            font-size: 1.2em;
        }

        .sent-indicator {
            color: #888;
        }

        .read-indicator {
            color: #4fc3f7;
        }

        .message-input-container {
            display: flex;
            padding: 15px;
            background-color: #f0f0f0;
            border-top: 1px solid #ccc;
            align-items: center;
        }

        .message-input-container input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
        }

        .message-input-container button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 10px;
        }

        .message-input-container button:hover {
            background-color: #0056b3;
        }

        .file-upload-btn {
            background-color: #28a745 !important;
        }

        .file-upload-btn:hover {
            background-color: #218838 !important;
        }

        .file-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 5px 0;
        }

        .file-message {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .file-link {
            color: #007bff;
            text-decoration: none;
            margin-top: 5px;
        }

        .file-link:hover {
            text-decoration: underline;
        }

        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            margin: 5px 0;
            cursor: pointer;
        }

        .message-image:hover {
            opacity: 0.9;
        }

        .file-icon {
            font-size: 24px;
            margin-right: 8px;
            color: #666;
        }

        .file-info {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 5px;
            margin: 5px 0;
        }

        .file-name {
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        /* Styles for Members Display Panel */
        #membersDisplayPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 350px;
            max-height: 400px;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            z-index: 1000;
            padding: 20px;
            display: none;
            /* Hidden by default */
            flex-direction: column;
        }

        #membersDisplayPanel h4 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        #membersListUl {
            list-style-type: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }

        #membersListUl li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #membersListUl li:last-child {
            border-bottom: none;
        }

        #membersListUl .member-info {
            font-size: 0.9em;
        }

        #membersListUl .remove-member-btn {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        #membersListUl .remove-member-btn:hover {
            background-color: #cc0000;
        }

        #closeMembersPanelBtn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            align-self: flex-end;
        }

        #closeMembersPanelBtn:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="user-search-container">
            <input type="text" id="usernameInput" placeholder="Nhập username...">
            <button id="startChatButton">Bắt đầu Chat</button>
        </div>
        <div class="chat-list-container">
            <h3>Cuộc trò chuyện</h3>
            <ul id="chatList" style="list-style-type: none; padding: 0; margin: 0;">
                <!-- Chat items will be populated here -->
            </ul>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header" id="chatHeader">
            <span id="chatHeaderTitle">Chọn một cuộc trò chuyện</span>
            <div class="chat-header-actions">
                <button id="viewChatMembersButton" title="View Members" disabled><i class="fas fa-users"></i></button>
                <div class="add-member-ui">
                    <button id="showAddMemberInputButton" title="Add Member" disabled><i
                            class="fas fa-user-plus"></i></button>
                    <div id="addMemberInputContainer" style="display: none;">
                        <input type="text" id="addMemberUsernameInput" placeholder="Username">
                        <button id="confirmAddMemberButton">Thêm</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="messages-container" id="messagesContainer">
            <!-- Messages will be populated here -->
        </div>
        <div class="message-input-container">
            <input type="text" id="messageInput" placeholder="Nhập tin nhắn..." disabled>
            <input type="file" id="fileInput" style="display: none;">
            <button id="fileUploadButton" class="file-upload-btn" disabled>
                <i class="fas fa-paperclip"></i>
            </button>
            <button id="sendMessageButton" disabled>Gửi</button>
        </div>
    </div>

    <!-- Members Display Panel -->
    <div id="membersDisplayPanel">
        <h4>Thành viên Nhóm</h4>
        <ul id="membersListUl">
            <!-- Member items will be populated here -->
        </ul>
        <button id="closeMembersPanelBtn">Đóng</button>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080/lms';
        let stompClient = null;
        let currentChatBoxId = null;
        let currentUser = null;
        let selectedFile = null;

        document.addEventListener('DOMContentLoaded', function () {
            const token = localStorage.getItem("token");
            if (token) {
                try {
                    const decodedToken = jwt_decode(token);
                    console.log("Decoded Token Payload:", decodedToken);

                    const usernameFromToken = decodedToken.sub || decodedToken.username || decodedToken.name;
                    const fullNameFromToken = decodedToken.fullName || decodedToken.name || usernameFromToken;

                    if (usernameFromToken) {
                        currentUser = {
                            username: usernameFromToken,
                            fullName: fullNameFromToken
                        };
                        console.log("Current user set from decoded token:", currentUser);

                        const nowInSeconds = Math.floor(Date.now() / 1000);
                        if (decodedToken.exp && decodedToken.exp < nowInSeconds) {
                            console.warn("Token has expired. Redirecting to login.");
                            redirectToLogin();
                            return;
                        }

                        document.getElementById('messageInput').disabled = false;
                        document.getElementById('sendMessageButton').disabled = false;
                        document.getElementById('fileUploadButton').disabled = false;
                        connectWebSocket(token);
                        loadChatBoxes(token);
                    } else {
                        console.error("Username (e.g., 'sub' or 'username') not found in decoded JWT payload.", decodedToken);
                        redirectToLogin();
                    }
                } catch (error) {
                    console.error("Error decoding token or token is invalid:", error);
                    redirectToLogin();
                }
            } else {
                redirectToLogin();
            }

            document.getElementById('startChatButton').addEventListener('click', searchUserAndCreateChat);
            document.getElementById('sendMessageButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            document.getElementById('fileUploadButton').addEventListener('click', function () {
                if (currentChatBoxId) {
                    document.getElementById('fileInput').click();
                } else {
                    alert("Vui lòng chọn một cuộc trò chuyện trước khi gửi file.");
                }
            });

            document.getElementById('fileInput').addEventListener('change', function (e) {
                selectedFile = e.target.files[0];
                if (selectedFile) {
                    const fileType = selectedFile.type.split('/')[0];
                    const fileSize = selectedFile.size;
                    const maxSize = 10 * 1024 * 1024; // 10MB

                    if (fileSize > maxSize) {
                        alert("File quá lớn. Kích thước tối đa là 10MB.");
                        selectedFile = null;
                        this.value = '';
                        return;
                    }

                    let filePreview = '';
                    if (fileType === 'image') {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            filePreview = `<img src="${e.target.result}" class="file-preview" alt="Preview">`;
                            document.getElementById('messageInput').value = `[File: ${selectedFile.name}]`;
                            const existingFilePreview = document.querySelector('.file-preview');
                            if (existingFilePreview) existingFilePreview.remove();
                            document.getElementById('messageInput').insertAdjacentHTML('afterend', filePreview);
                        };
                        reader.readAsDataURL(selectedFile);
                    } else {
                        document.getElementById('messageInput').value = `[File: ${selectedFile.name}]`;
                    }
                }
            });

            document.getElementById('showAddMemberInputButton').addEventListener('click', toggleAddMemberInput);
            document.getElementById('confirmAddMemberButton').addEventListener('click', processAddMember);
            document.getElementById('viewChatMembersButton').addEventListener('click', () => {
                if (currentChatBoxId) {
                    fetchAndDisplayChatMembers(currentChatBoxId);
                }
            });
            document.getElementById('closeMembersPanelBtn').addEventListener('click', () => {
                document.getElementById('membersDisplayPanel').style.display = 'none';
            });
        });

        function redirectToLogin() {
            window.location.href = "/src/main/resources/static/loginn.html";
        }

        function connectWebSocket(token) {
            const socket = new SockJS(`${API_BASE_URL}/ws`);
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            const headers = token ? { 'Authorization': 'Bearer ' + token } : {};

            function connect() {
                stompClient.connect(headers,
                    function (frame) {
                        console.log("Kết nối WebSocket thành công:", frame);

                        // Gửi token khi subscribe
                        const subscribeHeaders = token ? { 'Authorization': 'Bearer ' + token } : {};

                        stompClient.subscribe(`/user/${currentUser.username}/queue/notifications`, function (message) {
                            const notification = JSON.parse(message.body);
                            console.log("Nhận thông báo chatbox mới/cập nhật từ /queue/notifications:", notification);
                            if (notification.chatBoxId && notification.listMemmber) {
                                addOrUpdateChatBoxToList(notification, true);
                            }
                        }, subscribeHeaders);
                    },
                    function (error) {
                        console.error("Lỗi kết nối WebSocket:", error);
                        // Tự động reconnect sau 5 giây
                        setTimeout(function () {
                            console.log("Đang thử kết nối lại...");
                            connect();
                        }, 5000);
                    }
                );
            }

            connect();
        }

        function loadChatBoxes(token) {
            fetch(`${API_BASE_URL}/chatBox?pageSize=100`, {
                headers: { "Authorization": "Bearer " + token }
            })
                .then(response => response.json())
                .then(apiResponse => {
                    if (apiResponse.result && apiResponse.result.content) {
                        displayChatBoxes(apiResponse.result.content);
                    } else {
                        console.error("Không thể tải danh sách chat:", apiResponse);
                    }
                })
                .catch(error => console.error("Lỗi khi tải danh sách chat:", error));
        }

        function getChatNameForDisplay(chatBox) {
            if (chatBox.name) return chatBox.name;
            if (!chatBox.isGroup && chatBox.listMemmber && currentUser) {
                const otherMember = chatBox.listMemmber.find(m => m.memberAccountUsername !== currentUser.username);
                return otherMember ? otherMember.memberFullname || otherMember.memberAccountUsername : "Chat cá nhân";
            }
            return chatBox.id;
        }

        function displayChatBoxes(chatBoxes) {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            chatBoxes.forEach(chatBox => {
                addOrUpdateChatBoxToList(chatBox, false);
            });
        }

        function addOrUpdateChatBoxToList(chatBoxData, isNewNotification) {
            const chatList = document.getElementById('chatList');
            let chatBoxId = chatBoxData.id || chatBoxData.chatBoxId;

            let existingItem = document.getElementById(`chatbox-${chatBoxId}`);
            if (existingItem) {
                if (isNewNotification) chatList.prepend(existingItem);
                return;
            }

            const listItem = document.createElement('li');
            listItem.className = 'chat-list-item';
            listItem.id = `chatbox-${chatBoxId}`;
            listItem.setAttribute('data-chatbox-id', chatBoxId);

            let displayName = "Unknown Chat";
            let members = [];

            if (isNewNotification) {
                displayName = chatBoxData.nameOfChatBox || getChatNameForDisplay(chatBoxData);
                members = chatBoxData.listMemmber;
            } else {
                displayName = chatBoxData.name || `Chat ID: ${chatBoxId.substring(0, 8)}`;
            }
            listItem.setAttribute('data-chatbox-name', displayName);

            const avatarInitial = displayName.substring(0, 1).toUpperCase();
            listItem.innerHTML = `
                <div class="chat-avatar">${avatarInitial}</div>
                <div class="chat-info">
                    <div class="chat-name">${displayName}</div>
                    <div class="last-message">Nhấp để mở chat...</div>
                </div>
            `;
            listItem.addEventListener('click', () => openChatBox(chatBoxId, displayName, members));

            if (isNewNotification) {
                chatList.prepend(listItem);
            } else {
                chatList.appendChild(listItem);
            }
        }

        function searchUserAndCreateChat() {
            const anotherUsername = document.getElementById('usernameInput').value.trim();
            if (!anotherUsername) {
                alert("Vui lòng nhập username.");
                return;
            }
            if (anotherUsername === currentUser?.username) {
                alert("Bạn không thể chat với chính mình.");
                return;
            }
            if (!currentUser || !currentUser.username) {
                alert("Không thể xác định người dùng hiện tại. Vui lòng thử đăng nhập lại.");
                console.error("currentUser is not set or username is missing before sending chat create request. CurrentUser:", currentUser);
                return;
            }

            if (stompClient && stompClient.connected) {
                const chatBoxCreateRequest = {
                    anotherAccounts: [anotherUsername],
                    currentAccountUsername: currentUser.username
                };
                console.log("Sending /chat/create payload:", JSON.stringify(chatBoxCreateRequest));
                stompClient.send("/app/chat/create", {}, JSON.stringify(chatBoxCreateRequest));
                console.log("Yêu cầu tạo chat đã gửi cho:", anotherUsername, "bởi", currentUser.username);
                document.getElementById('usernameInput').value = '';
            } else {
                alert("Chưa kết nối WebSocket. Vui lòng thử lại.");
            }
        }

        let currentChatSubscription = null;
        let currentAddMemberSubscription = null;

        function openChatBox(chatBoxId, chatName, members) {
            if (currentChatSubscription) {
                currentChatSubscription.unsubscribe();
                console.log("Unsubscribed from previous chat messages:", currentChatBoxId);
            }
            if (currentAddMemberSubscription) {
                currentAddMemberSubscription.unsubscribe();
                console.log("Unsubscribed from previous add member topic:", currentChatBoxId);
            }
            if (currentUser && currentUser.username && stompClient && stompClient.connected) {
                const userCreatedTopic = `/topic/chatbox/${currentUser.username}/created`;
            }

            currentChatBoxId = chatBoxId;
            document.getElementById('chatHeaderTitle').textContent = chatName || `Chat ID: ${chatBoxId}`;
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendMessageButton').disabled = false;
            document.getElementById('fileUploadButton').disabled = false;
            document.getElementById('showAddMemberInputButton').disabled = false;
            document.getElementById('viewChatMembersButton').disabled = false;
            document.getElementById('addMemberInputContainer').style.display = 'none';
            document.getElementById('addMemberUsernameInput').value = '';

            const existingPreview = document.querySelector('.file-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
            selectedFile = null;
            document.getElementById('fileInput').value = '';

            document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`chatbox-${chatBoxId}`)?.classList.add('active');

            console.log(`Đang mở chat: ${chatBoxId}`);
            markMessagesAsReadOnServer(chatBoxId);
            loadMessagesForChatBox(chatBoxId);

            if (stompClient && stompClient.connected) {
                const token = localStorage.getItem("token");
                const subscribeHeaders = token ? { 'Authorization': 'Bearer ' + token } : {};

                currentChatSubscription = stompClient.subscribe(`/topic/chatbox/${chatBoxId}`, function (message) {
                    const chatMessage = JSON.parse(message.body);
                    console.log("Nhận tin nhắn mới từ /topic/chatbox/" + chatBoxId + ":", chatMessage);
                    displayMessage(chatMessage);
                }, subscribeHeaders);
                console.log("Subscribed to /topic/chatbox/" + chatBoxId);

                currentAddMemberSubscription = stompClient.subscribe(`/topic/chatbox/${chatBoxId}/membersAdded`, function (message) {
                    const response = JSON.parse(message.body);
                    console.log("Received members added/updated response for " + chatBoxId + ":", response);
                    alert(`Thành viên đã được cập nhật cho cuộc trò chuyện: ${response.chatboxName || chatName || `Chat ID: ${chatBoxId}`}.`);
                    document.getElementById('chatHeaderTitle').textContent = response.chatboxName || chatName || `Chat ID: ${chatBoxId}`;
                    const chatListItem = document.getElementById(`chatbox-${response.chatboxId}`);
                    if (chatListItem && response.chatboxName) {
                        chatListItem.querySelector('.chat-name').textContent = response.chatboxName;
                        chatListItem.setAttribute('data-chatbox-name', response.chatboxName);
                    }
                }, subscribeHeaders);
                console.log("Subscribed to /topic/chatbox/" + chatBoxId + "/membersAdded");

                // TẠM THỜI COMMENT OUT SUBSCRIPTION GÂY RỐI ĐỂ TEST
                /*
                const userCreatedTopicPath = `/topic/chatbox/${currentUser.username}/created`;
                stompClient.subscribe(userCreatedTopicPath, function (message) {
                    const response = JSON.parse(message.body);
                    console.log("Callback for " + userCreatedTopicPath + ":", response);

                    if (response.chatBoxId) {
                        if (response.chatBoxId === currentChatBoxId) {
                            console.log("Notification on " + userCreatedTopicPath + " is for the current chat. Updating info if necessary.");
                            const newChatName = response.nameOfChatBox || response.name;
                            if (newChatName && document.getElementById('chatHeaderTitle').textContent !== newChatName) {
                                document.getElementById('chatHeaderTitle').textContent = newChatName;
                            }
                            const chatListItem = document.getElementById(`chatbox-${response.chatBoxId}`);
                            if (chatListItem && newChatName && chatListItem.querySelector('.chat-name').textContent !== newChatName) {
                                chatListItem.querySelector('.chat-name').textContent = newChatName;
                                chatListItem.setAttribute('data-chatbox-name', newChatName);
                            }
                        } else {
                            console.log("Notification on " + userCreatedTopicPath + " is for a NEW or DIFFERENT chat. Adding to list and opening: " + response.chatBoxId);
                            addOrUpdateChatBoxToList(response, true);
                            openChatBox(response.chatBoxId, response.nameOfChatBox || response.name, response.listMemmber);
                        }
                    } else {
                        console.log("Notification on " + userCreatedTopicPath + " lacks chatBoxId or is not relevant for opening.", response);
                    }
                }, subscribeHeaders);
                */
            } else {
                console.error("WebSocket chưa kết nối để subscribe vào topic chat.");
            }
        }

        function markMessagesAsReadOnServer(chatBoxIdToMark) {
            const token = localStorage.getItem("token");
            if (!token || !chatBoxIdToMark) return;

            fetch(`${API_BASE_URL}/chatBox/${chatBoxIdToMark}/messages/markAsRead`, {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
            })
                .then(response => {
                    if (!response.ok) {
                        console.error(`Error marking messages as read. Status: ${response.status}`);
                        response.text().then(text => console.error("Server error response for markAsRead:", text));
                    } else {
                        console.log(`Successfully sent markAsRead for chatBoxId: ${chatBoxIdToMark}`);
                    }
                })
                .catch(error => {
                    console.error("Network error or other issue marking messages as read:", error);
                });
        }

        function loadMessagesForChatBox(chatBoxIdToLoad) {
            const token = localStorage.getItem("token");
            console.warn(`API backend đang được gọi: GET /chatBox/${chatBoxIdToLoad}/messages để tải tin nhắn cũ.`);

            fetch(`${API_BASE_URL}/chatBox/${chatBoxIdToLoad}/messages?page=0&size=50&sort=createdAt,desc`, {
                headers: { "Authorization": "Bearer " + token }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Lỗi HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(apiResponse => {
                    if (apiResponse.result && apiResponse.result.content) {
                        const messages = apiResponse.result.content.reverse();
                        messages.forEach(msg => displayMessage(msg, true));
                        const messagesContainer = document.getElementById('messagesContainer');
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    } else if (apiResponse.code !== 0) {
                        console.error("Lỗi tải tin nhắn:", apiResponse.message || "Lỗi không xác định từ API");
                        document.getElementById('messagesContainer').innerHTML = `<p style="text-align:center; color:darkgray;">Chưa có tin nhắn nào.</p>`;
                    } else {
                        document.getElementById('messagesContainer').innerHTML = `<p style="text-align:center; color:darkgray;">Chưa có tin nhắn nào.</p>`;
                    }
                })
                .catch(error => {
                    console.error(`Lỗi khi tải tin nhắn cho chat box ${chatBoxIdToLoad}:`, error);
                    const messagesContainer = document.getElementById('messagesContainer');
                    messagesContainer.innerHTML = `<p style="text-align:center; color:red;">Không thể tải tin nhắn. ${error.message}.</p>`;
                });
        }

        function displayMessage(messageData, isLoadingHistory = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            const senderName = messageData.senderFullName || messageData.senderAccount;
            let statusIndicator = '';

            if (messageData.senderAccount === currentUser.username) {
                messageDiv.classList.add('sent');
                statusIndicator = '<span class="status-indicator sent-indicator">✓</span>';
            } else {
                messageDiv.classList.add('received');
                statusIndicator = '<span class="status-indicator read-indicator">✓✓</span>';
            }

            let contentHtml = '';
            if (messageData.path) {
                const fileType = messageData.type || 'file';
                const fileName = messageData.filename || 'File';

                if (fileType === 'image') {
                    contentHtml = `
                        <div class="file-message">
                            <img src="${API_BASE_URL}/${messageData.path}" class="message-image" onclick="openImageInNewTab('${API_BASE_URL}/${messageData.path}')" alt="${fileName}">
                            <a href="${API_BASE_URL}/${messageData.path}" class="file-link" target="_blank">Tải xuống</a>
                        </div>
                    `;
                } else {
                    const fileIcon = getFileIcon(fileType);
                    contentHtml = `
                        <div class="file-message">
                            <div class="file-info">
                                <i class="${fileIcon} file-icon"></i>
                                <span class="file-name">${fileName}</span>
                            </div>
                            <a href="${API_BASE_URL}/${messageData.path}" class="file-link" target="_blank">Tải xuống</a>
                        </div>
                    `;
                }
            } else {
                contentHtml = `<div class="message-content">${messageData.content}</div>`;
            }

            messageDiv.innerHTML = `
                <div class="sender-name">${senderName}</div>
                ${contentHtml}
                <div class="message-time-container">
                    <span class="message-time">${formatTimestamp(messageData.createdAt)}</span>
                    ${statusIndicator}
                </div>
            `;

            if (isLoadingHistory) {
                messagesContainer.insertBefore(messageDiv, messagesContainer.firstChild);
            } else {
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            if (!isLoadingHistory && messagesContainer.scrollHeight - messagesContainer.scrollTop > messagesContainer.clientHeight + 100) {
            } else if (!isLoadingHistory) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function getFileIcon(fileType) {
            switch (fileType.toLowerCase()) {
                case 'video':
                    return 'fas fa-video';
                case 'audio':
                    return 'fas fa-music';
                case 'pdf':
                    return 'fas fa-file-pdf';
                case 'word':
                case 'doc':
                case 'docx':
                    return 'fas fa-file-word';
                case 'excel':
                case 'xls':
                case 'xlsx':
                    return 'fas fa-file-excel';
                case 'powerpoint':
                case 'ppt':
                case 'pptx':
                    return 'fas fa-file-powerpoint';
                case 'zip':
                case 'rar':
                case '7z':
                    return 'fas fa-file-archive';
                default:
                    return 'fas fa-file';
            }
        }

        function openImageInNewTab(imageUrl) {
            window.open(imageUrl, '_blank');
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        function sendMessage() {
            const messageContent = document.getElementById('messageInput').value.trim();
            if (!messageContent && !selectedFile) {
                return;
            }
            if (!currentChatBoxId) {
                alert("Vui lòng chọn một cuộc trò chuyện trước.");
                return;
            }

            if (!currentUser || !currentUser.username) {
                alert("Lỗi: Không thể xác định người gửi. Vui lòng tải lại trang.");
                return;
            }

            if (stompClient && stompClient.connected) {
                const messageRequest = {
                    chatBoxId: currentChatBoxId,
                    senderAccount: currentUser.username,
                    content: messageContent
                };

                const token = localStorage.getItem("token");
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};

                console.log("Sending message via WebSocket:", JSON.stringify(messageRequest));
                stompClient.send("/app/chat/sendMessage", headers, JSON.stringify(messageRequest));

                document.getElementById('messageInput').value = '';
                document.getElementById('fileInput').value = '';
                selectedFile = null;

                const existingPreview = document.querySelector('.file-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }
            } else {
                alert("Chưa kết nối WebSocket. Không thể gửi tin nhắn.");
            }
        }

        function toggleAddMemberInput() {
            const container = document.getElementById('addMemberInputContainer');
            container.style.display = container.style.display === 'none' ? 'flex' : 'none';
            if (container.style.display === 'flex') {
                document.getElementById('addMemberUsernameInput').focus();
            }
        }

        function processAddMember() {
            const usernameToAdd = document.getElementById('addMemberUsernameInput').value.trim();
            if (!usernameToAdd) {
                alert("Vui lòng nhập username của thành viên muốn thêm.");
                return;
            }

            if (!currentChatBoxId) {
                alert("Vui lòng chọn một cuộc trò chuyện trước khi thêm thành viên.");
                return;
            }

            if (!currentUser || !currentUser.username) {
                alert("Lỗi: Không thể xác định người yêu cầu. Vui lòng tải lại trang.");
                return;
            }

            if (usernameToAdd === currentUser.username) {
                alert("Bạn không thể tự thêm chính mình vào cuộc trò chuyện một lần nữa.");
                return;
            }

            if (stompClient && stompClient.connected) {
                const addMemberRequest = {
                    chatboxId: currentChatBoxId,
                    usernameOfRequestor: currentUser.username,
                    chatMemberRequests: [
                        { memberAccount: usernameToAdd }
                    ]
                };

                console.log("Sending /chat/addMembers payload:", JSON.stringify(addMemberRequest));
                stompClient.send("/app/chat/addMembers", {}, JSON.stringify(addMemberRequest));

                document.getElementById('addMemberUsernameInput').value = '';
                document.getElementById('addMemberInputContainer').style.display = 'none';
            } else {
                alert("Chưa kết nối WebSocket. Không thể thêm thành viên.");
            }
        }

        function fetchAndDisplayChatMembers(chatBoxIdToFetch) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Lỗi xác thực. Vui lòng đăng nhập lại.");
                return;
            }

            console.log(`Fetching members for chatBoxId: ${chatBoxIdToFetch}`);
            fetch(`${API_BASE_URL}/chatBox/${chatBoxIdToFetch}/members`, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Lỗi ${response.status}: ${text || response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(apiResponse => {
                    if (apiResponse && apiResponse.result && Array.isArray(apiResponse.result)) {
                        const members = apiResponse.result;
                        displayChatMembers(members);
                    } else {
                        console.error("API response for members is not in expected format:", apiResponse);
                        alert("Không thể lấy danh sách thành viên hoặc danh sách trống.");
                        document.getElementById('membersDisplayPanel').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error(`Lỗi khi tải danh sách thành viên cho chat box ${chatBoxIdToFetch}:`, error);
                    alert(`Không thể tải danh sách thành viên: ${error.message}`);
                    document.getElementById('membersDisplayPanel').style.display = 'none';
                });
        }

        function displayChatMembers(members) {
            const membersListUl = document.getElementById('membersListUl');
            membersListUl.innerHTML = '';

            if (members.length === 0) {
                membersListUl.innerHTML = '<li>Không có thành viên nào (hoặc chỉ có bạn).</li>';
                document.getElementById('membersDisplayPanel').style.display = 'flex';
                return;
            }

            members.forEach(member => {
                const listItem = document.createElement('li');
                let memberHtml = `<span class="member-info">${member.accountUsername} (Tham gia: ${formatTimestamp(member.joinedAt) || 'N/A'})</span>`;

                if (currentUser && member.accountUsername !== currentUser.username) {
                    memberHtml += ` <button class="remove-member-btn" data-username="${member.accountUsername}">Xoá</button>`;
                }
                listItem.innerHTML = memberHtml;
                membersListUl.appendChild(listItem);
            });

            document.querySelectorAll('#membersListUl .remove-member-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const usernameToRemove = this.dataset.username;
                    if (confirm(`Bạn có chắc muốn xoá thành viên ${usernameToRemove} khỏi nhóm không?`)) {
                        processRemoveMember(currentChatBoxId, usernameToRemove);
                    }
                });
            });

            document.getElementById('membersDisplayPanel').style.display = 'flex';
        }

        function processRemoveMember(chatBoxId, memberUsernameToRemove) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Lỗi xác thực. Vui lòng đăng nhập lại.");
                return;
            }

            console.log(`Attempting to remove member ${memberUsernameToRemove} from chatBoxId: ${chatBoxId}`);
            fetch(`${API_BASE_URL}/chatBox/${chatBoxId}/members/${memberUsernameToRemove}`, {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Lỗi ${response.status}: ${text || 'Không thể xoá thành viên.'}`);
                        });
                    }
                    return response.text();
                })
                .then(data => {
                    alert(`Đã xoá thành viên ${memberUsernameToRemove} thành công!`);
                    fetchAndDisplayChatMembers(chatBoxId);
                })
                .catch(error => {
                    console.error(`Lỗi khi xoá thành viên ${memberUsernameToRemove}:`, error);
                    alert(`Lỗi khi xoá thành viên: ${error.message}`);
                });
        }

    </script>
</body>

</html>